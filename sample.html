<!DOCTYPE html>
<html>

<head>
    <title>Stacked Bar Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <canvas id="myChart"></canvas>
    <script>
        const data = [
            {
                ending_balance: "45,943",
                interest: "242",
                loan_paid_percentage: "91.89",
                payment_date: "Aug 2023",
                principle: "4,057",
            },
            {
                ending_balance: "41,866",
                interest: "222",
                loan_paid_percentage: "83.73",
                payment_date: "Sep 2023",
                principle: "4,077",
            },
            {
                ending_balance: "37,769",

                interest: "202",
                loan_paid_percentage: "75.54",
                payment_date: "Oct 2023",
                principle: "4,097",
            }
        ];


        // Group data by year and calculate the sum of principle, interest, and ending_balance for each year
        let groupedData = data.reduce((acc, cur) => {
            let year = cur.payment_date.split(' ')[1];
            if (!acc[year]) {
                acc[year] = {
                    principle: 0,
                    interest: 0,
                    ending_balance: 0,
                    loan_paid_percentage: 0
                };
            }
            acc[year].principle += parseInt(cur.principle.replace(',', ''));
            acc[year].interest += parseInt(cur.interest);
            acc[year].ending_balance += parseInt(cur.ending_balance.replace(',', ''));
            acc[year].loan_paid_percentage = parseFloat(cur.loan_paid_percentage);
            return acc;
        }, {});

        // Extract labels/dates
        let labels = Object.keys(groupedData);

        // Extract principle dataset
        let principle = Object.values(groupedData).map(item => item.principle);

        // Extract interest dataset
        let interest = Object.values(groupedData).map(item => item.interest);

        // Extract ending balance dataset
        let ending_balance = Object.values(groupedData).map(item => item.ending_balance);

        // Create the chart
        let ctx = document.getElementById('myChart').getContext('2d');
        let myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Principle',
                        yAxisID: 'bar-y-axis', // specify the y-axis for the bar chart
                        data: principle,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,

                        stack: 'combined',
                        type: 'bar'
                    },
                    {
                        label: 'Interest',
                        yAxisID: 'bar-y-axis', // specify the y-axis for the bar chart
                        data: interest,
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1,

                        stack: 'combined',
                        type: 'bar'
                    },
                    {
                        label: 'Ending Balance',
                        yAxisID: 'line-y-axis', // specify the y-axis for the line chart
                        data: ending_balance,
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1,

                        stack: 'combined',
                        type: 'line'
                    }
                ]
            },
            options: {
                scales: {
                    'bar-y-axis': { // configuration for the bar chart y-axis
                        position: 'right',
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Principle and Interest',
                        },
                    },
                    'line-y-axis': { // configuration for the line chart y-axis
                        position: 'left',
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Balance',
                        },
                    }
                },
                tooltips: {
                    callbacks: {
                        title: function (tooltipItems, data) {
                            return 'Year: ' + tooltipItems[0].label;
                        },
                        label: function (tooltipItem, data) {
                            let datasetLabel = data.datasets[tooltipItem.datasetIndex].label;
                            let value = tooltipItem.value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                            switch (tooltipItem.datasetIndex) {
                                case 0:
                                    return datasetLabel + ' Paid: $ ' + value;
                                case 1:
                                    return datasetLabel + ': $ ' + value;
                                case 2:
                                    return datasetLabel + ': $ ' + value;
                            }
                        }
                    }
                }
            }
        });

    </script>
</body>

</html>